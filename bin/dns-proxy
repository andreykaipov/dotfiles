#!/bin/sh

main() {
    # idk sudo can't follow symlinks or something (maybe a Nix thing)
    dns_proxy="$(command -v dns_proxy)"

    # it's going to overwrite our /etc/resolv.conf so back it up
    sudo cp /etc/resolv.conf /etc/resolv.conf.bak
    sudo chattr -i /etc/resolv.conf

    trap cleanup INT TERM

    cd ~/.config/dnsproxy || return
    rm -f debug.log
    sudo "$dns_proxy" ./dnsproxy.conf # goes to background immediately
    tail -f debug.log &
    pid="$!"
    cd - >/dev/null || return

    wait
}

cleanup() {
    kill -9 "$pid"
    pkill -9 dns_proxy

    sudo chattr -i /etc/resolv.conf
    sudo mv /etc/resolv.conf.bak /etc/resolv.conf
    sudo chattr +i /etc/resolv.conf

    echo
}

main "$@"
